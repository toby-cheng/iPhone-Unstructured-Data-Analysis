---
title: "Tob_FunWordThings"
author: "Ming Ki Toby Cheng"
date: "2/10/2020"
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(scales)
library(lubridate)
library(tidytext)
library(RColorBrewer)
library(wordcloud)
```

```{r}
alldata <- read_csv('alldata.csv')
```

## Summarizing Text
```{r}
iphone8reviewsT <- filter(alldata, Type == 'iphone8') %>%
  unnest_tokens(word,Text) %>%
  anti_join(stop_words)

wordFreq <- iphone8reviewsT %>%
  count(word,sort = T)

wordFreq %>%
  slice(1:25) %>%
  ggplot(aes(x=fct_reorder(word,n),y=n)) + 
  geom_bar(stat='identity') + 
  coord_flip() +
  scale_y_continuous(labels=comma)+
  labs(x='Word',
       y='Word  Frequency',
       title = 'Top Words in iPhone8 Reviews',
       subtitle = paste0('Based on ',nrow(filter(alldata, Type == 'iphone8')),' reviews')
  )
```
```{r}
alldataT <- alldata %>%
  select(Heading, Text, Rating, Time, Type) %>%
  unnest_tokens(word,Text)

nPhones <- alldata %>%
  count(Type) %>%
  arrange(desc(n))

tmp <- alldataT %>%
  count(Type,word) %>%
  bind_tf_idf(word,Type,n) %>%
  group_by(Type) %>%
  arrange(desc(tf_idf)) %>%
  slice(1:15) %>% # get top 15 words in terms of tf-idf
  ungroup() %>%
  mutate(xOrder=n():1)

tmp %>%
  filter(Type %in% nPhones$Type) %>%
  ggplot(aes(x=xOrder,y=tf_idf,fill=as.factor(Type))) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  facet_wrap(~ Type,scales='free') +
  scale_x_continuous(breaks = tmp$xOrder,
                     labels = tmp$word,
                     expand = c(0,0)) + 
  coord_flip()+ theme_bw() + 
  labs(x='Word',y='Word  Frequency',
       title = 'Review Contents',
       subtitle = 'Top TF-IDF Words used in Reviews by Type')


```

```{r}
iphone8TBi <- filter(alldata, Type == 'iphone8') %>%
  unnest_tokens(bigram,Text, token = "ngrams", n = 2)

topWords <- iphone8TBi %>%
  count(bigram, sort = T) %>%
  separate(bigram, c("word1", "word2"), sep = " ", remove = F) %>%
  slice(1:25) %>%
  ungroup() %>%
  mutate(xOrder=n():1)

topWords %>%
  ggplot(aes(x=xOrder,y=n)) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_continuous(breaks = topWords$xOrder,labels = topWords$bigram,expand = c(0,0)) + 
  coord_flip()+ theme_bw()+ theme(legend.position = "none")+
  labs(x='Word',y='Word  Frequency',
       title = 'Top Bigrams for iPhone 8 Reviews')


```

```{r}
iphoneXTBi <- filter(alldata, Type == 'iphoneX') %>%
  unnest_tokens(bigram,Text, token = "ngrams", n = 2)

topWords <- iphoneXTBi %>%
  count(bigram, sort = T) %>%
  separate(bigram, c("word1", "word2"), sep = " ", remove = F) %>%
  slice(1:25) %>%
  ungroup() %>%
  mutate(xOrder=n():1)

topWords %>%
  ggplot(aes(x=xOrder,y=n)) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_continuous(breaks = topWords$xOrder,labels = topWords$bigram,expand = c(0,0)) + 
  coord_flip()+ theme_bw()+ theme(legend.position = "none")+
  labs(x='Word',y='Word  Frequency',
       title = 'Top Bigrams for iPhone X Reviews')


```

```{r}
iphone11promaxTBi <- filter(alldata, Type == 'iphone11promax') %>%
  unnest_tokens(bigram,Text, token = "ngrams", n = 2)

topWords <- iphone11promaxTBi %>%
  count(bigram, sort = T) %>%
  separate(bigram, c("word1", "word2"), sep = " ", remove = F) %>%
  slice(1:25) %>%
  ungroup() %>%
  mutate(xOrder=n():1)

topWords %>%
  ggplot(aes(x=xOrder,y=n)) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_continuous(breaks = topWords$xOrder,labels = topWords$bigram,expand = c(0,0)) + 
  coord_flip()+ theme_bw()+ theme(legend.position = "none")+
  labs(x='Word',y='Word  Frequency',
       title = 'Top Bigrams for iPhone 11 Pro Max Reviews')


```

```{r}
alldata %>%
  group_by(Type) %>%
  unnest_tokens(bigram,Text,token="ngrams",n=2) %>%
  count(bigram) %>%
  arrange(desc(n)) %>%
  top_n(10) %>%
  ggplot(aes(x=reorder_within(bigram, n, Type),
             y=n, fill = factor(Type))) + 
  geom_bar(stat='identity') + scale_x_reordered() +
  facet_wrap(~ Type,scales='free', ncol = 3) +
  coord_flip() +
  theme(legend.position = "none")+
  labs(title = 'Top Title Bigrams in Different Phone Types',
       x = 'Bigram',
       y = 'Count')
```

```{r}
customWords <- c('iphone','phone', '8', 'apple')

topWords <- iphone8TBi %>%
  count(bigram, sort = T) %>%
  separate(bigram, c("word1", "word2"), sep = " ", remove = F) %>%
  filter(!word1 %in% stop_words$word,
         !word2 %in% stop_words$word,
         !word1 %in% customWords,
         !word2 %in% customWords,
         !word1 %in% customWords,
         !word2 %in% customWords
  ) %>%
  slice(1:25) %>%
  ungroup() %>%
  mutate(xOrder=n():1)

topWords %>%
  ggplot(aes(x=xOrder,y=n)) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_continuous(breaks = topWords$xOrder,labels = topWords$bigram,expand = c(0,0)) + 
  coord_flip()+ theme_bw()+ theme(legend.position = "none")+
  labs(x='Bigram',y='Frequency',
       title = 'Top Bigrams, iPhone 8',
       subtitle = 'Stop-words removed')
```

```{r}

customWords <- c('iphone','phone', 'X', 'apple')

topWords <- iphoneXTBi %>%
  count(bigram, sort = T) %>%
  separate(bigram, c("word1", "word2"), sep = " ", remove = F) %>%
  filter(!word1 %in% stop_words$word,
         !word2 %in% stop_words$word,
         !word1 %in% customWords,
         !word2 %in% customWords,
         !word1 %in% customWords,
         !word2 %in% customWords
  ) %>%
  slice(1:25) %>%
  ungroup() %>%
  mutate(xOrder=n():1)

topWords %>%
  ggplot(aes(x=xOrder,y=n)) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_continuous(breaks = topWords$xOrder,labels = topWords$bigram,expand = c(0,0)) + 
  coord_flip()+ theme_bw()+ theme(legend.position = "none")+
  labs(x='Bigram',y='Frequency',
       title = 'Top Bigrams, iPhone X',
       subtitle = 'Stop-words removed')
```

```{r}
customWords <- c('iphone','phone', '11', 'apple', 'pro', 'max','color','midnight', 'green')

topWords <- iphone11promaxTBi %>%
  count(bigram, sort = T) %>%
  separate(bigram, c("word1", "word2"), sep = " ", remove = F) %>%
  filter(!word1 %in% stop_words$word,
         !word2 %in% stop_words$word,
         !word1 %in% customWords,
         !word2 %in% customWords,
         !word1 %in% customWords,
         !word2 %in% customWords
  ) %>%
  slice(1:25) %>%
  ungroup() %>%
  mutate(xOrder=n():1)

topWords %>%
  ggplot(aes(x=xOrder,y=n)) + 
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_continuous(breaks = topWords$xOrder,labels = topWords$bigram,expand = c(0,0)) + 
  coord_flip()+ theme_bw()+ theme(legend.position = "none")+
  labs(x='Bigram',y='Frequency',
       title = 'Top Bigrams, iPhone 11 Pro Max',
       subtitle = 'Stop-words removed')
```

## Sentiment Analysis

```{r}
library(knitr)
install.packages("sentimentr")
library(sentimentr)
install.packages("textdata")
library(textdata)
install.packages("ggridges")
library(ggridges)
```

### iPhone8 Average Sentiment
```{r}
reviewsTidy <- filter(alldata, Type == 'iphone8') %>%
  unnest_tokens(word,Text) 

reviewsLength <- reviewsTidy %>%
  count(X1) %>%
  rename(reviewLength = n)
  
sentRev <- reviewsTidy %>%
  inner_join(get_sentiments("afinn")) %>%
  group_by(X1) %>%
  summarize(sentiment = sum(value)) %>%
  left_join(reviewsLength,by='X1') %>%
  mutate(aveSentiment = sentiment/reviewLength)

sentByStar8 <- sentRev %>%
  left_join(select(filter(alldata, Type == 'iphone8'),X1,Rating), by='X1')


nReviews <- nrow(filter(alldata, Type == 'iphone8'))

sentByStar8 %>%
  group_by(Rating) %>%
  summarize(meanSent = mean(aveSentiment)) %>%
  mutate(Rating=factor(Rating)) %>%
  ggplot(aes(x=Rating,y=meanSent,color=Rating)) + geom_point(size=5,show.legend = F) + 
  geom_hline(aes(yintercept=0)) +
  labs(title='Average Sentiment by Review Rating',
       subtitle = paste0(nReviews,'Best Buy reviews of the iPhone 8'),
       x = 'Review Star Rating',
       y = 'Average Sentiment')

```

```{r}

sentByStar8 %>%
  mutate(Rating=factor(Rating)) %>% 
  ggplot(aes(x = aveSentiment, y = Rating, group = Rating,fill=Rating)) +
  geom_density_ridges(scale = 2.0, size = 0.25,alpha=0.4,show.legend=F) +
  scale_x_continuous(limits=c(-.2, 0.8), expand = c(0.01, 0)) +
  theme_bw() + 
  geom_vline(aes(xintercept=0)) + 
  labs(x = 'Review Sentiment',
       y = 'Review Rating',
       title = 'Distribution of Review Sentiment by Review Star Rating',
       subtitle = paste0(nReviews, ' Reviews of iPhone 8'))


```

### iPhoneX Average Sentiment
```{r}
reviewsTidy <- filter(alldata, Type == 'iphoneX') %>%
  unnest_tokens(word,Text) 

reviewsLength <- reviewsTidy %>%
  count(X1) %>%
  rename(reviewLength = n)
  
sentRev <- reviewsTidy %>%
  inner_join(get_sentiments("afinn")) %>%
  group_by(X1) %>%
  summarize(sentiment = sum(value)) %>%
  left_join(reviewsLength,by='X1') %>%
  mutate(aveSentiment = sentiment/reviewLength)

sentByStarX <- sentRev %>%
  left_join(select(filter(alldata, Type == 'iphoneX'),X1,Rating), by='X1')


nReviews <- nrow(filter(alldata, Type == 'iphoneX'))

sentByStarX %>%
  group_by(Rating) %>%
  summarize(meanSent = mean(aveSentiment)) %>%
  mutate(Rating=factor(Rating)) %>%
  ggplot(aes(x=Rating,y=meanSent,color=Rating)) + geom_point(size=5,show.legend = F) + 
  geom_hline(aes(yintercept=0)) +
  labs(title='Average Sentiment by Review Rating',
       subtitle = paste0(nReviews,'Best Buy reviews of the iPhone X'),
       x = 'Review Star Rating',
       y = 'Average Sentiment')

```

```{r}

sentByStarX %>%
  mutate(Rating=factor(Rating)) %>% 
  ggplot(aes(x = aveSentiment, y = Rating, group = Rating,fill=Rating)) +
  geom_density_ridges(scale = 2.0, size = 0.25,alpha=0.4,show.legend=F) +
  scale_x_continuous(limits=c(-.2, 0.8), expand = c(0.01, 0)) +
  theme_bw() + 
  geom_vline(aes(xintercept=0)) + 
  labs(x = 'Review Sentiment',
       y = 'Review Rating',
       title = 'Distribution of Review Sentiment by Review Star Rating',
       subtitle = paste0(nReviews, ' Reviews of iPhone X'))


```

### iPhone 11 Pro Max Average Sentiment
```{r}
reviewsTidy <- filter(alldata, Type == 'iphone11promax') %>%
  unnest_tokens(word,Text) 

reviewsLength <- reviewsTidy %>%
  count(X1) %>%
  rename(reviewLength = n)
  
sentRev <- reviewsTidy %>%
  inner_join(get_sentiments("afinn")) %>%
  group_by(X1) %>%
  summarize(sentiment = sum(value)) %>%
  left_join(reviewsLength,by='X1') %>%
  mutate(aveSentiment = sentiment/reviewLength)

sentByStar11 <- sentRev %>%
  left_join(select(filter(alldata, Type == 'iphone11promax'),X1,Rating), by='X1')


nReviews <- nrow(filter(alldata, Type == 'iphone11promax'))

sentByStar11 %>%
  group_by(Rating) %>%
  summarize(meanSent = mean(aveSentiment)) %>%
  mutate(Rating=factor(Rating)) %>%
  ggplot(aes(x=Rating,y=meanSent,color=Rating)) + geom_point(size=5,show.legend = F) + 
  geom_hline(aes(yintercept=0)) +
  labs(title='Average Sentiment by Review Rating',
       subtitle = paste0(nReviews,'Best Buy reviews of the iPhone 11 Pro Max'),
       x = 'Review Star Rating',
       y = 'Average Sentiment')

```

```{r}

sentByStar11 %>%
  mutate(Rating=factor(Rating)) %>% 
  ggplot(aes(x = aveSentiment, y = Rating, group = Rating,fill=Rating)) +
  geom_density_ridges(scale = 2.0, size = 0.25,alpha=0.4,show.legend=F) +
  scale_x_continuous(limits=c(-.2, 0.8), expand = c(0.01, 0)) +
  theme_bw() + 
  geom_vline(aes(xintercept=0)) + 
  labs(x = 'Review Sentiment',
       y = 'Review Rating',
       title = 'Distribution of Review Sentiment by Review Star Rating',
       subtitle = paste0(nReviews, ' Reviews of iPhone 11 Pro Max'))


```

### iPhone 8 Sentiment through Review
```{r}

plot_words <- filter(alldata, Type == 'iphone8')  %>%
  unnest_tokens(word, Text)

nReviews <- nrow(filter(alldata, Type == 'iphone8'))

decile_counts <- plot_words %>%
  group_by(X1) %>%
  mutate(word_position = row_number() / n()) %>%
  ungroup() %>%
  mutate(decile = ceiling(word_position * 10) / 10) %>%
  count(decile, word)


nWordsByDec <- decile_counts %>%
  count(decile,wt=n)


AfinnVersion <- decile_counts %>%
  inner_join(get_sentiments("afinn"), by = "word") %>%
  group_by(decile) %>%
  summarize(score = sum(value * n) / sum(n)) %>%
  ggplot(aes(decile, score)) +
  geom_line(color='red',size=2) +
  scale_x_continuous(labels = percent_format()) +
  expand_limits(y = 0) +
  labs(title = "Average Sentiment by Position in Review",
       subtitle = paste0("Average over ", nReviews ,"Reviews"),
       x = "Position within Review",
       caption = "Based on AFINN Sentiment Lexicon",
       y = "Average Sentiment Score (higher is more positive)")

BingVersion <- decile_counts %>%
  inner_join(get_sentiments("bing"), by = "word") %>%
  group_by(decile,sentiment) %>%
  summarize(Total = sum(n)) %>%
  ggplot(aes(x=decile,y=Total,color=sentiment,group=sentiment)) + 
  geom_line() + geom_point(size=3) +
  scale_x_continuous(labels = percent_format()) +
  labs(title = "Counts of Word Polarity By Position in Review",
       subtitle = paste0(nReviews ," Reviews"),
       x = "Position within Review",
       caption = "Based on Bing Sentiment Lexicon",
       y = "Count of Sentiment Loaded Words")
```


```{r, fig.height = 5.25, fig.width=9}
AfinnVersion
```


```{r, fig.height = 5.25, fig.width=9}
BingVersion
```

